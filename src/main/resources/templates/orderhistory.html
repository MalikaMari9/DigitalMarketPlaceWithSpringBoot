<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Order History</title>
    
    <link rel="stylesheet" th:href="@{/CSS/orderhistory.css}">
    <link rel="stylesheet" th:href="@{/CSS/headerFooter.css}">
    
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script th:src="@{/JS/sidebar.js}"></script>
    <script th:src="@{/JS/CategorySelect.js}"></script>
</head>
<body>
<header th:insert="fragments/header :: header"></header>

    <div class="checkout-body">
        <div class="completed-orders-wrapper" th:each="receipt : ${receipts}">
            
            <!-- Order Header -->
            <div class="order-history-header">
            
                <h2>Order from <a th:href="@{/viewSeller/{sellerID}(sellerID=${receipt.seller.userID})}" class="shop-name" th:text="${receipt.seller.username}"></a></h2> 
                <p class="receipt-id">Receipt ID: <span th:text="${receipt.receiptID}"></span></p>
                <p><strong>Total:</strong> <span class="order-price" th:text="'USD ' + ${receipt.totalPrice}"></span></p>
            </div>

            <!-- Order Items -->
            <div class="order-card" th:each="order : ${receipt.orders}">
                <div class="order-card-header">

                    <img th:src="@{${order.item.getThumbnail()}}" alt="Product Image" class="order-image">
                    
                    <div class="order-info">
                        <h4 class="order-title" th:text="${order.item.itemName}"></h4>
                        <p class="order-date"><i class="fas fa-calendar-alt"></i> <span th:text="${#temporals.format(order.receipt.createdAt, 'yyyy-MM-dd HH:mm')}"></span></p>
                    </div>

                    <div class="order-actions">
                        <button class="buy-again" th:attr="data-item-id=${order.item.itemID}">
                           Buy Again
                        </button>
                    </div>
                </div>

                <div class="order-details">
                    <p><strong>Order No:</strong> <span th:text="${order.orderID}"></span></p>
                    <p><strong>Price × Quantity:</strong> <span class="order-price" th:text="'MMK ' + ${order.price} + ' × ' + ${order.quantity}"></span></p>
                </div> 
            </div>

            <!-- Download Invoice -->
            <div class="order-footer">
                <button class="download-button" th:attr="data-receipt-id=${receipt.receiptID}">
                    <i class="fas fa-file-download"></i> Download Invoice
                </button>
            </div>

        </div>
    </div>

<footer th:insert="fragments/footer :: footer"></footer>
<script>
    lucide.createIcons();
</script>
<script>
document.addEventListener("DOMContentLoaded", () => {
    document.querySelectorAll(".buy-again").forEach((btn) => {
        btn.addEventListener("click", () => {
            const itemID = btn.getAttribute("data-item-id");

            fetch(`/add-to-cart?itemID=${itemID}`, { method: "POST" })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert("✅ Item added to cart!");
                    } else {
                        alert("❌ " + data.message);
                    }
                })
                .catch(error => console.error("❌ Error:", error));
        });
    });

    // ✅ Invoice Download
    document.querySelectorAll(".download-button").forEach((btn) => {
        btn.addEventListener("click", () => {
            const receiptID = btn.getAttribute("data-receipt-id");
            window.location.href = `/download-invoice/${receiptID}`;
        });
    });
});
</script>

</body>
</html>
